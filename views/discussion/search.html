{{ extend 'layout.html' }}
<section>
    {{ if request.vars.search_text: }}
    <h2>{{ =T('Search Results for "%s"', symbols=request.vars.search_text) }}</h2>
    {{ search_results = discussions.getDiscussionSearchResults(db, request.vars.search_text) }}
    {{ elif request.vars.search_tag: }}
    <h2>{{ =T('Search Results for "%s" Tag', symbols=request.vars.search_tag) }}</h2>
    {{ search_results = discussions.getTagSearchResults(db, request.vars.search_tag) }}
    {{ else: }}
    <h2>{{ =T('All Discussions') }}</h2>
    {{ search_results = db(db.conversation.id > 0).select() }}
    {{ pass }}
    <ul class="unlabled conversation-list">
        {{ for discussion in search_results: }}
        <li>
            <h3>
                {{ =discussions.highlightWords(discussion.title, request.vars.search_text or "") }}
                {{ if discussions.hasUserContributed(db, discussion.id, session.logged_in_user): }}
                <sup title="{{ =T('You have contributed to this discussion') }}" class="fa fa-exclamation"></sup>
                {{ pass }}
            </h3>
            <div class="tag-list">
                {{ if discussions.hasSiteTags(db, discussion.id): }}
                <span title="{{ =T('Site Tags') }}" class="fa fa-tag fa-lg site-tag"></span>
                {{ for tag in discussions.getSiteTags(db, discussion.id): }}
                <a href="{{ =URL('discussion', 'search', vars={'search_tag': tag.name}) }}" class="tag">{{ =tag.name }}</a>
                {{ pass }}
                {{ pass }}
                {{ if discussions.hasUserTags(db, discussion.id): }}
                <span title="{{ =T('User Tags') }}" class="fa fa-tag fa-lg user-tag"></span>
                {{ for tag in discussions.getUserTags(db, discussion.id): }}
                {{ pass }}
                <a href="{{ =URL('discussion', 'search', vars={'search_tag': tag.name}) }}" class="tag">{{ =tag.name }}</a>
                {{ pass }}
            </div>
            {{ count = discussions.getMessageCount(db, discussion.id) }}
            {{ =T('There %%{is} %d %%{comment}.', symbols=count) }}
            {{ =T('The most recent was %s.', symbols=discussions.getLastMessageTime(db, discussion.id)) }}
            <div class="conversation-links">
                <a href="{{ =URL('discussion', 'view', args=[discussion.id]) }}" title="Discussion {{ =discussion.id }}">
                    {{ =T('Go to original post') }}
                </a>
                {{ message = discussions.getMostRecentMessage(db, discussion.id) }}
                <a href="{{ =URL('discussion', 'view', args=[discussion.id], anchor='message-'+str(message.id)) }}" title="Discussion {{ =discussion.id }}">
                    {{ =T('Go to latest comment') }}
                </a>
            </div>
        </li>
        {{ pass }}
    </ul>
</section>