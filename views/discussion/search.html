{{ extend 'layout.html' }}
<section>
    <h2>{{ =T('Search Results') if request.vars.search_text else T('All Discussions') }}</h2>
    <ul class="unlabled conversation-list">
        {{ for discussion in db(db.conversation.id > 0).select(): }}
        <li>
            <h3>
                {{ =discussion.title }}
                {{ if discussions.hasUserContributed(db, discussion.id, session.logged_in_user): }}
                <sup title="{{ =T('You have contributed to this discussion') }}" class="fa fa-exclamation"></sup>
                {{ pass }}
            </h3>
            <div class="tag-list">
                {{ if discussions.hasSiteTags(db, discussion.id): }}
                <span class="fa fa-tag site-tag"></span>
                {{ for tag in discussions.getSiteTags(db, discussion.id): }}
                <span>{{ =tag.name }}</span>
                {{ pass }}
                {{ pass }}
                {{ if discussions.hasUserTags(db, discussion.id): }}
                <span class="fa fa-tag user-tag"></span>
                {{ for tag in discussions.getUserTags(db, discussion.id): }}
                {{ pass }}
                <span>{{ =tag.name }}</span>
                {{ pass }}

                <span class="fa fa-tag site-tag fa-lg"></span>
                <span class="tag">cd-meta</span>
                <span class="tag">cd-rules</span>
            </div>
            {{ count = discussions.getMessageCount(db, discussion.id) }}
            {{ =T('There are %d comments.') % count if count != 1 else T('There is 1 comment.') }}
            {{ =T('The most recent was %s.') % discussions.getLastMessageTime(db, discussion.id) }}
            <div class="conversation-links">
                <a href="{{ =URL('discussion', 'view', args=[discussion.id]) }}" title="Discussion {{ =discussion.id }}">
                    {{ =T('Go to original post') }}
                </a>
                {{ message = discussions.getMostRecentMessage(db, discussion.id) }}
                <a href="{{ =URL('discussion', 'view', args=[discussion.id], anchor='message-'+str(message.id)) }}" title="Discussion {{ =discussion.id }}">
                    {{ =T('Go to latest comment') }}
                </a>
            </div>
        </li>
        {{ pass }}
    </ul>
</section>